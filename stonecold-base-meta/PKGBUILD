# Maintainer: StoneCold <forumi0721[at]gmail[dot]com>

_localpkgver=Y
pkgname=("stonecold-base-meta")
pkgver=20150306.1
pkgrel=1
pkgdesc="Install base packages"
arch=("any")
url="http://localhost/"
license=("custom")
depends=(
  "abs"
  "afpfs-ng"
  "arch-install-scripts"
  "autostart"
  "bash-completion"
  "bash-completion-btrfs"
  "btrfs-progs"
  "cifs-utils"
  "cpio"
  "cronie"
  "dosfstools"
  "elinks"
  "ethtool"
  "f2fs-tools"
  "gptfdisk"
  "haveged"
  "hd-idle"
  "mc"
  "ncftp"
  "net-tools"
  "ntfs-3g"
  "openssh"
  "p7zip"
  "pkgfile"
  "screen"
  "sudo"
  "unrar"
  "unzip"
  "vi-vim-symlink"
  "vim"
  "wget"
  "yaourt"
  "zip"
)
install="${pkgname}.install"
source=("${pkgname}.tar.xz")
md5sums=("SKIP")

pkgver() {
  local date="$(date +'%Y%m%d')"
  local revision="1"
  local pkgarch="${arch}"
  if [ "${pkgarch}" != "any" ]; then
    pkgarch="${CARCH}"
  fi
  if [ "$(echo "${pkgver}" | cut -d '.' -f 1)" = "${date}" ]; then
    revision="$(echo "${pkgver}" | cut -d '.' -f 2)"
  fi
  for pkg in $(ls "${startdir}"/${pkgname}-${date}.*-${pkgrel}-*.pkg.tar.* 2> /dev/null)
  do
    local prevpkgrev="$(echo "${pkg}" | sed 's/^\(.*\)-\(.*\)\.\(.*\)-\(.*\)-\(.*\)\.pkg\.tar\..*$/\3/g')"
    if [ "${prevpkgrev}" -ge "${revision}" ]; then
      revision="${prevpkgrev}"
    fi
  done

  local prevpkg=$(ls "${startdir}"/${pkgname}-${date}.${revision}-${pkgrel}-${pkgarch}.pkg.tar.* 2> /dev/null)
  if [ ! -z "${prevpkg}" ]; then
    revision="$((${revision} + 1))"
  fi

  echo "${date}.${revision}"
}

package() {
  install -dm755 "${pkgdir}/etc/"
  install -Dm644 "${srcdir}/${pkgname}/etc/locale.conf" "${pkgdir}/etc/"

  install -dm755 "${pkgdir}/etc/"
  install -Dm644 "${srcdir}/${pkgname}/etc/bash.bashrc2" "${pkgdir}/etc/"

  install -dm755 "${pkgdir}/etc/ssh"
  install -Dm600 "${srcdir}/${pkgname}/etc/ssh/ssh_host_dsa_key" "${pkgdir}/etc/ssh/"
  install -Dm644 "${srcdir}/${pkgname}/etc/ssh/ssh_host_dsa_key.pub" "${pkgdir}/etc/ssh/"
  install -Dm600 "${srcdir}/${pkgname}/etc/ssh/ssh_host_ecdsa_key" "${pkgdir}/etc/ssh/"
  install -Dm644 "${srcdir}/${pkgname}/etc/ssh/ssh_host_ecdsa_key.pub" "${pkgdir}/etc/ssh/"
  install -Dm600 "${srcdir}/${pkgname}/etc/ssh/ssh_host_ed25519_key" "${pkgdir}/etc/ssh/"
  install -Dm644 "${srcdir}/${pkgname}/etc/ssh/ssh_host_ed25519_key.pub" "${pkgdir}/etc/ssh/"
  install -Dm600 "${srcdir}/${pkgname}/etc/ssh/ssh_host_key" "${pkgdir}/etc/ssh/"
  install -Dm644 "${srcdir}/${pkgname}/etc/ssh/ssh_host_key.pub" "${pkgdir}/etc/ssh/"
  install -Dm600 "${srcdir}/${pkgname}/etc/ssh/ssh_host_rsa_key" "${pkgdir}/etc/ssh/"
  install -Dm644 "${srcdir}/${pkgname}/etc/ssh/ssh_host_rsa_key.pub" "${pkgdir}/etc/ssh/"

  install -dm750 "${pkgdir}/etc/sudoers.d"
  install -Dm644 "${srcdir}/${pkgname}/etc/sudoers.d/sudoers" "${pkgdir}/etc/sudoers.d/"

  install -Dm644 "${srcdir}/${pkgname}/etc/vimrc2" "${pkgdir}/etc/"
}

# vim:set ts=2 sw=2 et:
